
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Eunseop Kim">
      
      
        <link rel="canonical" href="https://markean.github.io/aimz/impact_model/">
      
      
        <link rel="prev" href="../model_persistence/">
      
      
        <link rel="next" href="../array_dataset/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>ImpactModel - aimz</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#impactmodel" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="aimz" class="md-header__button md-logo" aria-label="aimz" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            aimz
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ImpactModel
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/markean/aimz" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    markean/aimz
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="aimz" class="md-nav__button md-logo" aria-label="aimz" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    aimz
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/markean/aimz" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    markean/aimz
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WIP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model_persistence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model Persistence
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Model
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    ImpactModel
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    ImpactModel
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ImpactModel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.vi_result" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;vi_result
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__del__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__getstate__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__getstate__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__setstate__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__setstate__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.sample_prior_predictive" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;sample_prior_predictive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.sample" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;sample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.sample_posterior_predictive" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;sample_posterior_predictive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.train_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;train_on_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.fit_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;fit_on_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;fit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.is_fitted" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;is_fitted
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.set_posterior_sample" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_posterior_sample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.predict_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;predict_on_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;predict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.estimate_effect" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;estimate_effect
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.log_likelihood" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;log_likelihood
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;cleanup
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1" >
        
          
          <label class="md-nav__link" for="__nav_4_2_1" id="__nav_4_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../array_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ArrayDataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../array_loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ArrayLoader
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ImpactModel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.vi_result" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;vi_result
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__del__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__getstate__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__getstate__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.__setstate__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__setstate__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.sample_prior_predictive" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;sample_prior_predictive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.sample" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;sample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.sample_posterior_predictive" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;sample_posterior_predictive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.train_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;train_on_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.fit_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;fit_on_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.fit" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;fit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.is_fitted" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;is_fitted
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.set_posterior_sample" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_posterior_sample
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.predict_on_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;predict_on_batch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.predict" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;predict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.estimate_effect" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;estimate_effect
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.log_likelihood" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;log_likelihood
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aimz.model.impact_model.ImpactModel.cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;cleanup
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  
    
      
    
    <a href="https://github.com/markean/aimz/raw/master/docs/impact_model.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="impactmodel">ImpactModel<a class="headerlink" href="#impactmodel" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-class">



<a id="aimz.model.impact_model.ImpactModel"></a>
    <div class="doc doc-contents first">


        <p>A class for impact modeling.</p>







              <details class="quote">
                <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImpactModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for impact modeling.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">inference</span><span class="p">:</span> <span class="n">SVI</span> <span class="o">|</span> <span class="n">MCMC</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">param_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
        <span class="n">param_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an ImpactModel instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            kernel (Callable): A probabilistic model with Pyro primitives.</span>
<span class="sd">            rng_key (Array): A pseudo-random number generator key.</span>
<span class="sd">            inference (SVI | MCMC): An inference method supported by NumPyro, such</span>
<span class="sd">                as an instance of `numpyro.infer.svi.SVI` or `numpyro.infer.mcmc.MCMC`.</span>
<span class="sd">            param_input (str, optional): The name of the parameter in the `kernel` for</span>
<span class="sd">                the main input data.</span>
<span class="sd">            param_output (str, optional): The name of the parameter in the `kernel` for</span>
<span class="sd">                the output data.</span>

<span class="sd">        Warning:</span>
<span class="sd">            The `rng_key` parameter should be provided as a **typed key array**</span>
<span class="sd">            created with `jax.random.key()`, rather than a legacy `uint32` key created</span>
<span class="sd">            with `jax.random.PRNGKey()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">param_input</span><span class="p">,</span> <span class="n">param_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rng_key</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint32</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Legacy `uint32` PRNGKey detected; converting to a typed key array.&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">wrap_key_data</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span> <span class="o">=</span> <span class="n">rng_key</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inference</span><span class="p">,</span> <span class="p">(</span><span class="n">SVI</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported inference object: `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">inference</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`. &quot;</span>
                <span class="s2">&quot;Expected `SVI` or `MCMC` from `numpyro.infer`.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">inference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_runtime_attrs</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_runtime_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize runtime attributes.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">:</span> <span class="n">Mesh</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">:</span> <span class="n">NamedSharding</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">num_devices</span> <span class="o">=</span> <span class="n">local_device_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_devices</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="n">make_mesh</span><span class="p">((</span><span class="n">num_devices</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">NamedSharding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Backend: </span><span class="si">%s</span><span class="s2">, Devices: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">default_backend</span><span class="p">(),</span>
            <span class="n">num_devices</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the temporary directory when the instance is deleted.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="c1"># Call the parent&#39;s __del__ method only if it exists and is callable</span>
        <span class="n">super_del</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="s2">&quot;__del__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">super_del</span><span class="p">):</span>
            <span class="n">super_del</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the state of the object excluding runtime attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The state of the object, excluding runtime attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_fn&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;_device&quot;</span><span class="p">,</span> <span class="s2">&quot;_mesh&quot;</span><span class="p">,</span> <span class="s2">&quot;_num_devices&quot;</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore the state and reinitialize runtime attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            state (dict): The state to restore, excluding the runtime attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_runtime_attrs</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vi_result</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SVIRunResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current variational inference result.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The stored result from variational inference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vi_result</span>

    <span class="nd">@vi_result</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vi_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vi_result</span><span class="p">:</span> <span class="n">SVIRunResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the variational inference result manually.</span>

<span class="sd">        This sets the result from a variational inference run and marks the model as</span>
<span class="sd">        fitted. It does not perform posterior sampling — use `.sample()` separately to</span>
<span class="sd">        obtain samples.</span>

<span class="sd">        Args:</span>
<span class="sd">            vi_result (SVIRunResult): The result from a prior variational inference run.</span>
<span class="sd">                It must be a NamedTuple or similar object with the following fields:</span>
<span class="sd">                - params (dict): Learned parameters from inference.</span>
<span class="sd">                - state (SVIState): Internal SVI state object.</span>
<span class="sd">                - losses (ArrayLike): Loss values recorded during optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vi_result</span><span class="o">.</span><span class="n">losses</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Loss contains NaN or Inf, indicating numerical instability.&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vi_result</span> <span class="o">=</span> <span class="n">vi_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_prior_predictive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw samples from the prior predictive distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">            num_samples (int, optional): The number of samples to draw.</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed.</span>
<span class="sd">            return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">                return. If `None`, samples all latent, observed, and deterministic</span>
<span class="sd">                sites.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Prior predictive samples.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.sample_prior_predictive()`.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_sample_forward</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span><span class="p">,</span>
            <span class="n">posterior_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">args_bound</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw posterior samples from a fitted model.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_samples (int, optional): The number of posterior samples to draw.</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed. Has no effect if</span>
<span class="sd">                the inference method is MCMC, where the `post_warmup_state` property</span>
<span class="sd">                will be used to continue sampling.</span>
<span class="sd">            return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">                return. If `None`, samples all latent sites. Has no effect if the</span>
<span class="sd">                inference method is MCMC.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays. Only relevant when the inference</span>
<span class="sd">                method is MCMC.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Posterior samples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
            <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
            <span class="n">args_bound</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="si">!r}</span><span class="s2"> must be provided in `.sample()`.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">post_warmup_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">last_state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">post_warmup_state</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="o">**</span><span class="n">args_bound</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">device_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">_sample_forward</span><span class="p">(</span>
            <span class="n">substitute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">guide</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">params</span><span class="p">),</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span><span class="p">,</span>
            <span class="n">posterior_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_posterior_predictive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw samples from the posterior predictive distribution.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed.</span>
<span class="sd">            return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">                return. If `None`, samples `self.param_output` and deterministic sites.</span>
<span class="sd">            intervention (dict | None, optional): A dictionary mapping sample sites to</span>
<span class="sd">                their corresponding intervention values. Interventions enable</span>
<span class="sd">                counterfactual analysis by modifying the specified sample sites during</span>
<span class="sd">                prediction (posterior predictive sampling).</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Posterior predictive samples.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.sample_prior_predictive()`.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">intervention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">seed</span><span class="p">(</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">intervention</span><span class="p">),</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_sample_forward</span><span class="p">(</span>
            <span class="n">kernel</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
            <span class="n">posterior_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">args_bound</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_on_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SVIState</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a single VI step on the given batch of data.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">            y (ArrayLike): Output data with shape `(n_samples_Y,)`.</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed. The key is only</span>
<span class="sd">                used for initialization if the internal SVI state is not yet set.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (SVIState): Updated SVI state after the training step.</span>
<span class="sd">            (ArrayLike): Loss value as a scalar array.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method updates the internal SVI state on every call, so it is not</span>
<span class="sd">            necessary to capture the returned state externally unless explicitly needed.</span>
<span class="sd">            However, the returned loss value can be used for monitoring or logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
            <span class="n">model_trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">))</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span>
                <span class="o">**</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Validate the kernel body for output sample site and naming conflicts</span>
            <span class="n">_validate_kernel_body</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
                <span class="n">model_trace</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">*</span><span class="p">(</span>
                    <span class="n">k</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deterministic&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                <span class="n">static_argnames</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_fields</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_on_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the impact model to the provided batch of data.</span>

<span class="sd">        This method behaves differently depending on the inference method specified at</span>
<span class="sd">        initialization of the ImpactModel instance:</span>

<span class="sd">        - **SVI:** Runs variational inference on the provided batch by invoking the</span>
<span class="sd">        `run()` method of the `SVI` instance from NumPyro to estimate the posterior</span>
<span class="sd">        distribution, then draws samples from it.</span>

<span class="sd">        - **MCMC:** Runs posterior sampling by invoking the `run()` method of the `MCMC`</span>
<span class="sd">            instance from NumPyro.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">            y (ArrayLike): Output data with shape `(n_samples_Y,)`.</span>
<span class="sd">            num_steps (int, optional): Number of steps for variational inference</span>
<span class="sd">                optimization. Has no effect if the inference method is MCMC.</span>
<span class="sd">            num_samples (int | None, optional): The number of posterior samples to draw.</span>
<span class="sd">                Has no effect if the inference method is MCMC.</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed.</span>
<span class="sd">            progress (bool, optional): Whether to display a progress bar. Has no effect</span>
<span class="sd">                if the inference method is MCMC.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The fitted model instance, enabling method chaining.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method continues training from the existing SVI state if available. To</span>
<span class="sd">            start training from scratch, create a new model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">,</span> <span class="n">check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">force_writeable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y_numeric</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>
            <span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
            <span class="o">.</span><span class="n">arguments</span>
        <span class="p">)</span>
        <span class="n">model_trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">))</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span>
            <span class="o">**</span><span class="n">args_bound</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Validate the kernel body for output sample site and naming conflicts</span>
        <span class="n">_validate_kernel_body</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
            <span class="n">model_trace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deterministic&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">SVI</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing variational inference optimization...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">rng_subkey</span><span class="p">,</span>
                <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
                <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                <span class="n">init_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span>
                <span class="o">**</span><span class="n">args_bound</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">state</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">losses</span><span class="p">)):</span>
                <span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Loss contains NaN or Inf, indicating numerical instability.&quot;</span><span class="p">,</span>
                    <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Posterior sampling...&quot;</span><span class="p">)</span>
            <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Posterior sampling...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_subkey</span><span class="p">,</span> <span class="o">**</span><span class="n">args_bound</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_dict_to_datatree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the impact model to the provided data using epoch-based training.</span>

<span class="sd">        This method implements an epoch-based training loop, where the data is iterated</span>
<span class="sd">        over in minibatches for a specified number of epochs. Variational inference is</span>
<span class="sd">        performed by repeatedly updating the model parameters on each minibatch, and</span>
<span class="sd">        then posterior samples are drawn from the fitted model.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike | ArrayLoader): Input data, either an array-like of shape</span>
<span class="sd">                `(n_samples, n_features)` or a data loader that holds all array-like</span>
<span class="sd">                objects and handles batching internally; if a data loader is passed,</span>
<span class="sd">                `batch_size` is ignored.</span>
<span class="sd">            y (ArrayLike | None): Output data with shape `(n_samples_Y,)`. Must be</span>
<span class="sd">                `None` if `X` is a data loader.</span>
<span class="sd">            num_samples (int | None, optional): The number of posterior samples to draw.</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed.</span>
<span class="sd">            progress (bool, optional): Whether to display a progress bar.</span>
<span class="sd">            batch_size (int | None, optional): The number of data points processed at</span>
<span class="sd">                each step of variational inference. If `None` (default), the entire</span>
<span class="sd">                dataset is used as a single batch in each epoch.</span>
<span class="sd">            epochs (int, optional): The number of epochs for variational inference</span>
<span class="sd">                optimization.</span>
<span class="sd">            shuffle (bool, optional): Whether to shuffle the data at each epoch.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The fitted model instance, enabling method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the inference method is MCMC.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method continues training from the existing SVI state if available.</span>
<span class="sd">            To start training from scratch, create a new model instance. It does not</span>
<span class="sd">            check whether the model or guide is written to support subsampling semantics</span>
<span class="sd">            (e.g., using NumPyro&#39;s `subsample` or similar constructs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;`.fit()` is not supported for MCMC inference. Use `.fit_on_batch()` &quot;</span>
                <span class="s2">&quot;instead.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>

        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="n">dataloader</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_setup_inputs</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing variational inference optimization...&quot;</span><span class="p">)</span>
        <span class="n">losses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="n">losses_epoch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">dataloader</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">batch</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span>
                    <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">loss_batch</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                <span class="n">losses_epoch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_batch</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">loss_batch</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
            <span class="n">losses_epoch_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses_epoch</span><span class="p">)</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">losses_epoch_arr</span><span class="p">)</span>
            <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> - &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Average loss: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_epoch_arr</span><span class="p">))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span> <span class="o">=</span> <span class="n">SVIRunResult</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">),</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span>
            <span class="n">losses</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">losses</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Loss contains NaN or Inf, indicating numerical instability.&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Posterior sampling...&quot;</span><span class="p">)</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_dict_to_datatree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check fitted status.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `True` if the model is fitted, `False` otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_is_fitted&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_posterior_sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">posterior_sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">],</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set posterior samples for the model.</span>

<span class="sd">        This method sets externally obtained posterior samples on the model instance,</span>
<span class="sd">        enabling downstream analysis without requiring a call to `.fit()` or</span>
<span class="sd">        `.fit_on_batch()`.</span>

<span class="sd">        It is primarily intended for workflows where posterior sampling is performed</span>
<span class="sd">        manually—for example, using NumPyro&#39;s `SVI` (or `MCMC`) with the `Predictive`</span>
<span class="sd">        API—and the resulting posterior samples are injected into the model for further</span>
<span class="sd">        use.</span>

<span class="sd">        Internally, `batch_ndims` is set to `1` by default to correctly handle the batch</span>
<span class="sd">        dimensions of the posterior samples. For more information, refer to the</span>
<span class="sd">        [NumPyro documentation](https://num.pyro.ai/en/stable/utilities.html#predictive).</span>

<span class="sd">        Args:</span>
<span class="sd">            posterior_sample (dict[str, Array]): Posterior samples to set for the model.</span>
<span class="sd">            return_sites (tuple[str] | None, optional): Names of variable (sites) to</span>
<span class="sd">                return in `.predict()`. By default, it is set to `self.param_output`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The model instance, treated as fitted with posterior samples set, enabling</span>
<span class="sd">                method chaining.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the batch shapes in `posterior_sample` are inconsistent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_ndims</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">batch_shapes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">batch_ndims</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">posterior_sample</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Inconsistent batch shapes found in posterior_sample: </span><span class="si">{</span><span class="n">batch_shapes</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,)</span> <span class="o">=</span> <span class="n">batch_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">posterior_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span> <span class="o">=</span> <span class="n">return_sites</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span> <span class="o">=</span> <span class="n">_dict_to_datatree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__sample_posterior_predictive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">fn_sample_posterior_predictive</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
        <span class="n">kwargs_array</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">dataloader</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_setup_inputs</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">desc</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Posterior predictive sampling [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">return_sites</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span>
            <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">rng_key</span><span class="p">,</span> <span class="o">*</span><span class="n">subkeys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">:</span>
            <span class="n">subkeys</span> <span class="o">=</span> <span class="n">device_put</span><span class="p">(</span>
                <span class="n">subkeys</span><span class="p">,</span>
                <span class="n">NamedSharding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">()),</span>
            <span class="p">)</span>

        <span class="n">zarr_group</span> <span class="o">=</span> <span class="n">open_group</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">zarr_arr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">error_queue</span> <span class="o">=</span> <span class="n">_start_writer_threads</span><span class="p">(</span>
            <span class="n">return_sites</span><span class="p">,</span>
            <span class="n">group_path</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">_writer</span><span class="p">,</span>
            <span class="n">queue_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">n_pad</span><span class="p">),</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">subkeys</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">kwargs_batch</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">dict_arr</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span>
                    <span class="n">fn_sample_posterior_predictive</span><span class="p">(</span>
                        <span class="n">kernel</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
                        <span class="n">subkey</span><span class="p">,</span>
                        <span class="n">return_sites</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">,</span>
                        <span class="n">kwargs_array</span><span class="o">.</span><span class="n">_fields</span> <span class="o">+</span> <span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span>
                        <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">],</span>
                        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs_batch</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs_extra</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">dict_arr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zarr_arr</span><span class="p">:</span>
                        <span class="n">zarr_arr</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">zarr_group</span><span class="o">.</span><span class="n">create_array</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bfloat16&quot;</span> <span class="k">else</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                            <span class="n">chunks</span><span class="o">=</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
                                <span class="n">dataloader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
                            <span class="p">),</span>
                            <span class="n">dimension_names</span><span class="o">=</span><span class="p">(</span>
                                <span class="s2">&quot;draw&quot;</span><span class="p">,</span>
                                <span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">_dim_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="n">queues</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span> <span class="p">:</span> <span class="o">-</span><span class="n">n_pad</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">error_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Sampling complete, writing in progress...&quot;</span><span class="p">)</span>
            <span class="n">_shutdown_writer_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_shutdown_writer_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception encountered. Cleaning up output directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">open_zarr</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">},</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">_make_attrs</span><span class="p">())</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span>
        <span class="n">out</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_on_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the output based on the fitted model.</span>

<span class="sd">        This method returns predictions for a single batch of input data and is better</span>
<span class="sd">        suited for:</span>
<span class="sd">            1) Models incompatible with `.predict()` due to their posterior sample</span>
<span class="sd">                shapes.</span>
<span class="sd">            2) Scenarios where writing results to to files (e.g., disk, cloud storage)</span>
<span class="sd">                is not desired.</span>
<span class="sd">            3) Smaller datasets, as this method may be slower due to limited</span>
<span class="sd">                parallelism.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">            intervention (dict | None, optional): A dictionary mapping sample sites to</span>
<span class="sd">                their corresponding intervention values. Interventions enable</span>
<span class="sd">                counterfactual analysis by modifying the specified sample sites during</span>
<span class="sd">                prediction (posterior predictive sampling).</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed.</span>
<span class="sd">            in_sample (bool, optional): Specifies the group where posterior predictive</span>
<span class="sd">                samples are stored in the returned output. If `True`, samples are stored</span>
<span class="sd">                in the `posterior_predictive` group, indicating they were generated</span>
<span class="sd">                based on data used during model fitting. If `False`, samples are stored</span>
<span class="sd">                in the `predictions` group, indicating they were generated based on</span>
<span class="sd">                out-of-sample data.</span>
<span class="sd">            return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">                return. If `None`, samples `self.param_output` and deterministic sites.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Posterior predictive samples. Posterior samples are included if available.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.predict_on_batch()`.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">intervention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">seed</span><span class="p">(</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">intervention</span><span class="p">),</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior_predictive&quot;</span> <span class="k">if</span> <span class="n">in_sample</span> <span class="k">else</span> <span class="s2">&quot;predictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dict_to_datatree</span><span class="p">(</span>
            <span class="n">_sample_forward</span><span class="p">(</span>
                <span class="n">kernel</span><span class="p">,</span>
                <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
                <span class="n">num_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
                <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
                <span class="n">posterior_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
                <span class="n">model_kwargs</span><span class="o">=</span><span class="n">args_bound</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict the output based on the fitted model.</span>

<span class="sd">        This method performs posterior predictive sampling to generate model-based</span>
<span class="sd">        predictions. It is optimized for batch processing of large input data and is not</span>
<span class="sd">        recommended for use in loops that process only a few inputs at a time. Results</span>
<span class="sd">        are written to disk in the Zarr format, with sampling and file writing decoupled</span>
<span class="sd">        and executed concurrently.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike | ArrayLoader): Input data, either an array-like of shape</span>
<span class="sd">                `(n_samples, n_features)` or a data loader that holds all array-like</span>
<span class="sd">                objects and handles batching internally; if a data loader is passed,</span>
<span class="sd">                `batch_size` is ignored.</span>
<span class="sd">            intervention (dict | None, optional): A dictionary mapping sample sites to</span>
<span class="sd">                their corresponding intervention values. Interventions enable</span>
<span class="sd">                counterfactual analysis by modifying the specified sample sites during</span>
<span class="sd">                prediction (posterior predictive sampling).</span>
<span class="sd">            rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">                default, an internal key is used and split as needed.</span>
<span class="sd">            in_sample (bool, optional): Specifies the group where posterior predictive</span>
<span class="sd">                samples are stored in the returned output. If `True`, samples are stored</span>
<span class="sd">                in the `posterior_predictive` group, indicating they were generated</span>
<span class="sd">                based on data used during model fitting. If `False`, samples are stored</span>
<span class="sd">                in the `predictions` group, indicating they were generated based on</span>
<span class="sd">                out-of-sample data.</span>
<span class="sd">            return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">                return. If `None`, samples `self.param_output` and deterministic sites.</span>
<span class="sd">            batch_size (int | None, optional): The size of batches for data loading</span>
<span class="sd">                during posterior predictive sampling. By default, it is set to the</span>
<span class="sd">                total number of samples (`n_samples_X`). This value also determines the</span>
<span class="sd">                chunk size for storing the posterior predictive samples.</span>
<span class="sd">            output_dir (str | Path | None, optional): The directory where the outputs</span>
<span class="sd">                will be saved. If the specified directory does not exist, it will be</span>
<span class="sd">                created automatically. If `None`, a default temporary directory will be</span>
<span class="sd">                created. A timestamped subdirectory will be generated within this</span>
<span class="sd">                directory to store the outputs. Outputs are saved in the Zarr format.</span>
<span class="sd">            progress (bool, optional): Whether to display a progress bar.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Posterior predictive samples. Posterior samples are included if available.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Check for compatibility with the `.predict()` method.</span>
        <span class="c1">#</span>
        <span class="c1"># If any array in the posterior has shape (num_samples, num_obs)—i.e.,</span>
        <span class="c1"># `ndim == 2` and the second dimension matches the number of observations in</span>
        <span class="c1"># `X`—it suggests that the model produces per-observation posterior samples.</span>
        <span class="c1"># This makes it incompatible with the current `.predict()` implementation, which</span>
        <span class="c1"># uses sharded parallelism. In such cases, fall back to `.predict_on_batch()`</span>
        <span class="c1"># and raise a warning.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">):</span>
            <span class="n">ndim_posterior_sample</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">ndim_posterior_sample</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;One or more posterior sample shapes are not compatible with &quot;</span>
                    <span class="s2">&quot;`.predict()` under sharded parallelism; falling back to &quot;</span>
                    <span class="s2">&quot;`.predict_on_batch()`.&quot;</span>
                <span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span>
                    <span class="n">X</span><span class="p">,</span>
                    <span class="n">intervention</span><span class="o">=</span><span class="n">intervention</span><span class="p">,</span>
                    <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
                    <span class="n">in_sample</span><span class="o">=</span><span class="n">in_sample</span><span class="p">,</span>
                    <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
            <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.predict()`.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">intervention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">seed</span><span class="p">(</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">intervention</span><span class="p">),</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>

        <span class="n">kwargs_array</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span> <span class="o">=</span> <span class="n">_create_sharded_sampler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_array</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_extra</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Temporary directory created at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No output directory provided. Using the model&#39;s temporary directory &quot;</span>
                <span class="s2">&quot;for storing output.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">output_subdir</span> <span class="o">=</span> <span class="n">_create_output_subdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sample_posterior_predictive</span><span class="p">(</span>
            <span class="n">fn_sample_posterior_predictive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span><span class="p">,</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span> <span class="k">if</span> <span class="n">in_sample</span> <span class="k">else</span> <span class="s2">&quot;predictions&quot;</span><span class="p">,</span>
            <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_subdir</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_baseline</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_intervention</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args_baseline</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">args_intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate the effect of an intervention.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_baseline (xr.DataTree | None, optional): Precomputed output for the</span>
<span class="sd">                baseline scenario.</span>
<span class="sd">            output_intervention (xr.DataTree | None, optional): Precomputed output for</span>
<span class="sd">                the intervention scenario.</span>
<span class="sd">            args_baseline (dict | None, optional): Input arguments for the baseline</span>
<span class="sd">                scenario. Passed to the `.predict()` method to compute predictions if</span>
<span class="sd">                `output_baseline` is not provided. Ignored if `output_baseline` is</span>
<span class="sd">                already given.</span>
<span class="sd">            args_intervention (dict | None, optional): Input arguments for the</span>
<span class="sd">                intervention scenario. Passed to the `.predict()` method to compute</span>
<span class="sd">                predictions if `output_intervention` is not provided. Ignored if</span>
<span class="sd">                `output_intervention` is already given.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The estimated impact of an intervention.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither `output_baseline` nor `args_baseline` is provided, or</span>
<span class="sd">                if neither `output_intervention` nor `args_intervention` is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_baseline</span><span class="p">:</span>
            <span class="n">dt_baseline</span> <span class="o">=</span> <span class="n">output_baseline</span>
        <span class="k">elif</span> <span class="n">args_baseline</span><span class="p">:</span>
            <span class="n">dt_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="o">**</span><span class="n">args_baseline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Either `output_baseline` or `args_baseline` must be provided.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_intervention</span><span class="p">:</span>
            <span class="n">dt_intervention</span> <span class="o">=</span> <span class="n">output_intervention</span>
        <span class="k">elif</span> <span class="n">args_intervention</span><span class="p">:</span>
            <span class="n">dt_intervention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="o">**</span><span class="n">args_intervention</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Either `output_intervention` or `args_intervention` must be provided.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">_validate_group</span><span class="p">(</span><span class="n">dt_baseline</span><span class="p">,</span> <span class="n">dt_intervention</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_intervention</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt_baseline</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_likelihood</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the log likelihood of the data under the given model.</span>

<span class="sd">        Results are written to disk in the Zarr format, with computing and file writing</span>
<span class="sd">        decoupled and executed concurrently.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (ArrayLike | ArrayLoader): Input data, either an array-like of shape</span>
<span class="sd">                `(n_samples, n_features)` or a data loader that holds all array-like</span>
<span class="sd">                objects and handles batching internally; if a data loader is passed,</span>
<span class="sd">                `batch_size` is ignored.</span>
<span class="sd">            y (ArrayLike | None): Output data with shape `(n_samples_Y,)`. Must be</span>
<span class="sd">                `None` if `X` is a data loader.</span>
<span class="sd">            batch_size (int | None, optional): The size of batches for data loading</span>
<span class="sd">                during posterior predictive sampling. By default, it is set to the total</span>
<span class="sd">                number of samples (`n_samples_X`). This value also determines the chunk</span>
<span class="sd">                size for storing the log-likelihood values.</span>
<span class="sd">            output_dir (str | Path | None, optional): The directory where the outputs</span>
<span class="sd">                will be saved. If the specified directory does not exist, it will be</span>
<span class="sd">                created automatically. If `None`, a default temporary directory will be</span>
<span class="sd">                created. A timestamped subdirectory will be generated within this</span>
<span class="sd">                directory to store the outputs. Outputs are saved in the Zarr format.</span>
<span class="sd">            progress (bool, optional): Whether to display a progress bar.</span>
<span class="sd">            **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">                values are expected to be JAX arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Log-likelihood values. Posterior samples are included if available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">kwargs_array</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span> <span class="o">=</span> <span class="n">_create_sharded_log_likelihood</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_array</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_extra</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Temporary directory created at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No output directory provided. Using the model&#39;s temporary directory &quot;</span>
                <span class="s2">&quot;for storing output.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">output_subdir</span> <span class="o">=</span> <span class="n">_create_output_subdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">dataloader</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_setup_inputs</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">desc</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing log-likelihood of </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span>
            <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">zarr_group</span> <span class="o">=</span> <span class="n">open_group</span><span class="p">(</span><span class="n">output_subdir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">zarr_arr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">error_queue</span> <span class="o">=</span> <span class="n">_start_writer_threads</span><span class="p">(</span>
            <span class="p">(</span><span class="n">site</span><span class="p">,),</span>
            <span class="n">group_path</span><span class="o">=</span><span class="n">output_subdir</span><span class="p">,</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">_writer</span><span class="p">,</span>
            <span class="n">queue_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">n_pad</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
                <span class="n">kwargs_batch</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span><span class="p">(</span>
                        <span class="c1"># Although computing the log-likelihood is deterministic, the</span>
                        <span class="c1"># model still needs to be seeded in order to trace its graph.</span>
                        <span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">,</span>
                        <span class="n">site</span><span class="p">,</span>
                        <span class="n">kwargs_array</span><span class="o">.</span><span class="n">_fields</span> <span class="o">+</span> <span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span>
                        <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">],</span>
                        <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">],</span>
                        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs_batch</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs_extra</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zarr_arr</span><span class="p">:</span>
                    <span class="n">zarr_arr</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">zarr_group</span><span class="o">.</span><span class="n">create_array</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bfloat16&quot;</span> <span class="k">else</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">chunks</span><span class="o">=</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
                            <span class="n">dataloader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                            <span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
                        <span class="p">),</span>
                        <span class="n">dimension_names</span><span class="o">=</span><span class="p">(</span>
                            <span class="s2">&quot;draw&quot;</span><span class="p">,</span>
                            <span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">_dim_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="n">queues</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span> <span class="p">:</span> <span class="o">-</span><span class="n">n_pad</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">error_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Computation complete, writing in progress...&quot;</span><span class="p">)</span>
            <span class="n">_shutdown_writer_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="n">queues</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_shutdown_writer_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="n">queues</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception encountered. Cleaning up output directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">output_subdir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">output_subdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">open_zarr</span><span class="p">(</span><span class="n">output_subdir</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
            <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">},</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">_make_attrs</span><span class="p">())</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the temporary directory created for storing outputs.</span>

<span class="sd">        If the temporary directory was never created or has already been cleaned up,</span>
<span class="sd">        this method does nothing. It does not delete any explicitly specified output</span>
<span class="sd">        directory. While the temporary directory is typically removed automatically</span>
<span class="sd">        during garbage collection, this behavior is not guaranteed. Therefore, calling</span>
<span class="sd">        this method explicitly is recommended to ensure timely resource release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Temporary directory cleaned up at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="aimz.model.impact_model.ImpactModel.vi_result" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <span class="doc doc-object-name doc-attribute-name">vi_result</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#aimz.model.impact_model.ImpactModel.vi_result" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">vi_result</span><span class="p">:</span> <span class="n"><span title="numpyro.infer.svi.SVIRunResult">SVIRunResult</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the current variational inference result.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpyro.infer.svi.SVIRunResult">SVIRunResult</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stored result from variational inference.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__init__</span>


<a href="#aimz.model.impact_model.ImpactModel.__init__" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">kernel</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span><span class="p">,</span> <span class="n">inference</span><span class="p">:</span> <span class="n"><span title="numpyro.infer.SVI">SVI</span></span> <span class="o">|</span> <span class="n"><span title="numpyro.infer.MCMC">MCMC</span></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">param_input</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">param_output</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kernel</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A probabilistic model with Pyro primitives.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inference</code>
            </td>
            <td>
                  <code><span title="numpyro.infer.SVI">SVI</span> | <span title="numpyro.infer.MCMC">MCMC</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An inference method supported by NumPyro, such
as an instance of <code>numpyro.infer.svi.SVI</code> or <code>numpyro.infer.mcmc.MCMC</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>param_input</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the parameter in the <code>kernel</code> for
the main input data.</p>
              </div>
            </td>
            <td>
                  <code>&#39;X&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>param_output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the parameter in the <code>kernel</code> for
the output data.</p>
              </div>
            </td>
            <td>
                  <code>&#39;y&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="warning" open>
  <summary>Warning</summary>
  <p>The <code>rng_key</code> parameter should be provided as a <strong>typed key array</strong>
created with <code>jax.random.key()</code>, rather than a legacy <code>uint32</code> key created
with <code>jax.random.PRNGKey()</code>.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span>
    <span class="n">inference</span><span class="p">:</span> <span class="n">SVI</span> <span class="o">|</span> <span class="n">MCMC</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">param_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
    <span class="n">param_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an ImpactModel instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        kernel (Callable): A probabilistic model with Pyro primitives.</span>
<span class="sd">        rng_key (Array): A pseudo-random number generator key.</span>
<span class="sd">        inference (SVI | MCMC): An inference method supported by NumPyro, such</span>
<span class="sd">            as an instance of `numpyro.infer.svi.SVI` or `numpyro.infer.mcmc.MCMC`.</span>
<span class="sd">        param_input (str, optional): The name of the parameter in the `kernel` for</span>
<span class="sd">            the main input data.</span>
<span class="sd">        param_output (str, optional): The name of the parameter in the `kernel` for</span>
<span class="sd">            the output data.</span>

<span class="sd">    Warning:</span>
<span class="sd">        The `rng_key` parameter should be provided as a **typed key array**</span>
<span class="sd">        created with `jax.random.key()`, rather than a legacy `uint32` key created</span>
<span class="sd">        with `jax.random.PRNGKey()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">param_input</span><span class="p">,</span> <span class="n">param_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rng_key</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint32</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Legacy `uint32` PRNGKey detected; converting to a typed key array.&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">wrap_key_data</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span> <span class="o">=</span> <span class="n">rng_key</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inference</span><span class="p">,</span> <span class="p">(</span><span class="n">SVI</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported inference object: `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">inference</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">`. &quot;</span>
            <span class="s2">&quot;Expected `SVI` or `MCMC` from `numpyro.infer`.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">inference</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_runtime_attrs</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.__del__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__del__</span>


<a href="#aimz.model.impact_model.ImpactModel.__del__" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__del__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Clean up the temporary directory when the instance is deleted.</p>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up the temporary directory when the instance is deleted.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="c1"># Call the parent&#39;s __del__ method only if it exists and is callable</span>
    <span class="n">super_del</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="s2">&quot;__del__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">super_del</span><span class="p">):</span>
        <span class="n">super_del</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.__getstate__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__getstate__</span>


<a href="#aimz.model.impact_model.ImpactModel.__getstate__" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__getstate__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the state of the object excluding runtime attributes.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The state of the object, excluding runtime attributes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the state of the object excluding runtime attributes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The state of the object, excluding runtime attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_fn&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;_device&quot;</span><span class="p">,</span> <span class="s2">&quot;_mesh&quot;</span><span class="p">,</span> <span class="s2">&quot;_num_devices&quot;</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.__setstate__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">__setstate__</span>


<a href="#aimz.model.impact_model.ImpactModel.__setstate__" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Restore the state and reinitialize runtime attributes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The state to restore, excluding the runtime attributes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restore the state and reinitialize runtime attributes.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The state to restore, excluding the runtime attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_runtime_attrs</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.sample_prior_predictive" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">sample_prior_predictive</span>


<a href="#aimz.model.impact_model.ImpactModel.sample_prior_predictive" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sample_prior_predictive</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_sites</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="jax.Array">Array</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Draw samples from the prior predictive distribution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data with shape <code>(n_samples_X, n_features)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of samples to draw.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_sites</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of variables (sites) to
return. If <code>None</code>, samples all latent, observed, and deterministic
sites.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="jax.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prior predictive samples.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>self.param_output</code> is passed as an argument.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample_prior_predictive</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw samples from the prior predictive distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">        num_samples (int, optional): The number of samples to draw.</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed.</span>
<span class="sd">        return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">            return. If `None`, samples all latent, observed, and deterministic</span>
<span class="sd">            sites.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Prior predictive samples.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
    <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.sample_prior_predictive()`.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_sample_forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span><span class="p">,</span>
        <span class="n">posterior_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="n">args_bound</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.sample" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">sample</span>


<a href="#aimz.model.impact_model.ImpactModel.sample" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sample</span><span class="p">(</span><span class="n">num_samples</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_sites</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="jax.Array">Array</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Draw posterior samples from a fitted model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of posterior samples to draw.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed. Has no effect if
the inference method is MCMC, where the <code>post_warmup_state</code> property
will be used to continue sampling.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_sites</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of variables (sites) to
return. If <code>None</code>, samples all latent sites. Has no effect if the
inference method is MCMC.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays. Only relevant when the inference
method is MCMC.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="jax.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Posterior samples.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw posterior samples from a fitted model.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_samples (int, optional): The number of posterior samples to draw.</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed. Has no effect if</span>
<span class="sd">            the inference method is MCMC, where the `post_warmup_state` property</span>
<span class="sd">            will be used to continue sampling.</span>
<span class="sd">        return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">            return. If `None`, samples all latent sites. Has no effect if the</span>
<span class="sd">            inference method is MCMC.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays. Only relevant when the inference</span>
<span class="sd">            method is MCMC.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Posterior samples.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">args_bound</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="si">!r}</span><span class="s2"> must be provided in `.sample()`.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">post_warmup_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">last_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">post_warmup_state</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="o">**</span><span class="n">args_bound</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">device_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">_sample_forward</span><span class="p">(</span>
        <span class="n">substitute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">guide</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">params</span><span class="p">),</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span><span class="p">,</span>
        <span class="n">posterior_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.sample_posterior_predictive" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">sample_posterior_predictive</span>


<a href="#aimz.model.impact_model.ImpactModel.sample_posterior_predictive" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sample_posterior_predictive</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_sites</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">intervention</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="jax.Array">Array</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Draw samples from the posterior predictive distribution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data with shape <code>(n_samples_X, n_features)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_sites</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of variables (sites) to
return. If <code>None</code>, samples <code>self.param_output</code> and deterministic sites.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intervention</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping sample sites to
their corresponding intervention values. Interventions enable
counterfactual analysis by modifying the specified sample sites during
prediction (posterior predictive sampling).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="jax.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Posterior predictive samples.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>self.param_output</code> is passed as an argument.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample_posterior_predictive</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw samples from the posterior predictive distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed.</span>
<span class="sd">        return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">            return. If `None`, samples `self.param_output` and deterministic sites.</span>
<span class="sd">        intervention (dict | None, optional): A dictionary mapping sample sites to</span>
<span class="sd">            their corresponding intervention values. Interventions enable</span>
<span class="sd">            counterfactual analysis by modifying the specified sample sites during</span>
<span class="sd">            prediction (posterior predictive sampling).</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Posterior predictive samples.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

    <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
    <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.sample_prior_predictive()`.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intervention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">seed</span><span class="p">(</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">intervention</span><span class="p">),</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_sample_forward</span><span class="p">(</span>
        <span class="n">kernel</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
        <span class="n">posterior_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="n">args_bound</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.train_on_batch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">train_on_batch</span>


<a href="#aimz.model.impact_model.ImpactModel.train_on_batch" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">train_on_batch</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="numpyro.infer.svi.SVIState">SVIState</span></span><span class="p">,</span> <span class="n"><span title="jax.Array">Array</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run a single VI step on the given batch of data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data with shape <code>(n_samples_X, n_features)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data with shape <code>(n_samples_Y,)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed. The key is only
used for initialization if the internal SVI state is not yet set.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpyro.infer.svi.SVIState">SVIState</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated SVI state after the training step.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Loss value as a scalar array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This method updates the internal SVI state on every call, so it is not
necessary to capture the returned state externally unless explicitly needed.
However, the returned loss value can be used for monitoring or logging.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_on_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SVIState</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a single VI step on the given batch of data.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">        y (ArrayLike): Output data with shape `(n_samples_Y,)`.</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed. The key is only</span>
<span class="sd">            used for initialization if the internal SVI state is not yet set.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (SVIState): Updated SVI state after the training step.</span>
<span class="sd">        (ArrayLike): Loss value as a scalar array.</span>

<span class="sd">    Note:</span>
<span class="sd">        This method updates the internal SVI state on every call, so it is not</span>
<span class="sd">        necessary to capture the returned state externally unless explicitly needed.</span>
<span class="sd">        However, the returned loss value can be used for monitoring or logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">model_trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">))</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span>
            <span class="o">**</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Validate the kernel body for output sample site and naming conflicts</span>
        <span class="n">_validate_kernel_body</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
            <span class="n">model_trace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">*</span><span class="p">(</span>
                <span class="n">k</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deterministic&quot;</span>
            <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
            <span class="n">static_argnames</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_fields</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_vi_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="o">**</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="n">loss</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.fit_on_batch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fit_on_batch</span>


<a href="#aimz.model.impact_model.ImpactModel.fit_on_batch" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">fit_on_batch</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Self">Self</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Fit the impact model to the provided batch of data.</p>
<p>This method behaves differently depending on the inference method specified at
initialization of the ImpactModel instance:</p>
<ul>
<li>
<p><strong>SVI:</strong> Runs variational inference on the provided batch by invoking the
<code>run()</code> method of the <code>SVI</code> instance from NumPyro to estimate the posterior
distribution, then draws samples from it.</p>
</li>
<li>
<p><strong>MCMC:</strong> Runs posterior sampling by invoking the <code>run()</code> method of the <code>MCMC</code>
    instance from NumPyro.</p>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data with shape <code>(n_samples_X, n_features)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data with shape <code>(n_samples_Y,)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_steps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of steps for variational inference
optimization. Has no effect if the inference method is MCMC.</p>
              </div>
            </td>
            <td>
                  <code>10000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of posterior samples to draw.
Has no effect if the inference method is MCMC.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a progress bar. Has no effect
if the inference method is MCMC.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Self">Self</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted model instance, enabling method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This method continues training from the existing SVI state if available. To
start training from scratch, create a new model instance.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_on_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the impact model to the provided batch of data.</span>

<span class="sd">    This method behaves differently depending on the inference method specified at</span>
<span class="sd">    initialization of the ImpactModel instance:</span>

<span class="sd">    - **SVI:** Runs variational inference on the provided batch by invoking the</span>
<span class="sd">    `run()` method of the `SVI` instance from NumPyro to estimate the posterior</span>
<span class="sd">    distribution, then draws samples from it.</span>

<span class="sd">    - **MCMC:** Runs posterior sampling by invoking the `run()` method of the `MCMC`</span>
<span class="sd">        instance from NumPyro.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">        y (ArrayLike): Output data with shape `(n_samples_Y,)`.</span>
<span class="sd">        num_steps (int, optional): Number of steps for variational inference</span>
<span class="sd">            optimization. Has no effect if the inference method is MCMC.</span>
<span class="sd">        num_samples (int | None, optional): The number of posterior samples to draw.</span>
<span class="sd">            Has no effect if the inference method is MCMC.</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed.</span>
<span class="sd">        progress (bool, optional): Whether to display a progress bar. Has no effect</span>
<span class="sd">            if the inference method is MCMC.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The fitted model instance, enabling method chaining.</span>

<span class="sd">    Note:</span>
<span class="sd">        This method continues training from the existing SVI state if available. To</span>
<span class="sd">        start training from scratch, create a new model instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">,</span> <span class="n">check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">force_writeable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y_numeric</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
    <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>
        <span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
        <span class="o">.</span><span class="n">arguments</span>
    <span class="p">)</span>
    <span class="n">model_trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">))</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span>
        <span class="o">**</span><span class="n">args_bound</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Validate the kernel body for output sample site and naming conflicts</span>
    <span class="n">_validate_kernel_body</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
        <span class="n">model_trace</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deterministic&quot;</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">SVI</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing variational inference optimization...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">rng_subkey</span><span class="p">,</span>
            <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
            <span class="n">progress_bar</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="n">init_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span>
            <span class="o">**</span><span class="n">args_bound</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">state</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">losses</span><span class="p">)):</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Loss contains NaN or Inf, indicating numerical instability.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Posterior sampling...&quot;</span><span class="p">)</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Posterior sampling...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_subkey</span><span class="p">,</span> <span class="o">**</span><span class="n">args_bound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">get_samples</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_dict_to_datatree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.fit" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fit</span>


<a href="#aimz.model.impact_model.ImpactModel.fit" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="aimz.utils.data.ArrayLoader" href="../array_loader/#aimz.utils.data.array_loader.ArrayLoader">ArrayLoader</a></span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">epochs</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Self">Self</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Fit the impact model to the provided data using epoch-based training.</p>
<p>This method implements an epoch-based training loop, where the data is iterated
over in minibatches for a specified number of epochs. Variational inference is
performed by repeatedly updating the model parameters on each minibatch, and
then posterior samples are drawn from the fitted model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span> | <a class="autorefs autorefs-internal" title="aimz.utils.data.ArrayLoader" href="../array_loader/#aimz.utils.data.array_loader.ArrayLoader">ArrayLoader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data, either an array-like of shape
<code>(n_samples, n_features)</code> or a data loader that holds all array-like
objects and handles batching internally; if a data loader is passed,
<code>batch_size</code> is ignored.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data with shape <code>(n_samples_Y,)</code>. Must be
<code>None</code> if <code>X</code> is a data loader.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of posterior samples to draw.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a progress bar.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of data points processed at
each step of variational inference. If <code>None</code> (default), the entire
dataset is used as a single batch in each epoch.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>epochs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of epochs for variational inference
optimization.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shuffle</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to shuffle the data at each epoch.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Self">Self</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted model instance, enabling method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the inference method is MCMC.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This method continues training from the existing SVI state if available.
To start training from scratch, create a new model instance. It does not
check whether the model or guide is written to support subsampling semantics
(e.g., using NumPyro's <code>subsample</code> or similar constructs).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the impact model to the provided data using epoch-based training.</span>

<span class="sd">    This method implements an epoch-based training loop, where the data is iterated</span>
<span class="sd">    over in minibatches for a specified number of epochs. Variational inference is</span>
<span class="sd">    performed by repeatedly updating the model parameters on each minibatch, and</span>
<span class="sd">    then posterior samples are drawn from the fitted model.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike | ArrayLoader): Input data, either an array-like of shape</span>
<span class="sd">            `(n_samples, n_features)` or a data loader that holds all array-like</span>
<span class="sd">            objects and handles batching internally; if a data loader is passed,</span>
<span class="sd">            `batch_size` is ignored.</span>
<span class="sd">        y (ArrayLike | None): Output data with shape `(n_samples_Y,)`. Must be</span>
<span class="sd">            `None` if `X` is a data loader.</span>
<span class="sd">        num_samples (int | None, optional): The number of posterior samples to draw.</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed.</span>
<span class="sd">        progress (bool, optional): Whether to display a progress bar.</span>
<span class="sd">        batch_size (int | None, optional): The number of data points processed at</span>
<span class="sd">            each step of variational inference. If `None` (default), the entire</span>
<span class="sd">            dataset is used as a single batch in each epoch.</span>
<span class="sd">        epochs (int, optional): The number of epochs for variational inference</span>
<span class="sd">            optimization.</span>
<span class="sd">        shuffle (bool, optional): Whether to shuffle the data at each epoch.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The fitted model instance, enabling method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the inference method is MCMC.</span>

<span class="sd">    Note:</span>
<span class="sd">        This method continues training from the existing SVI state if available.</span>
<span class="sd">        To start training from scratch, create a new model instance. It does not</span>
<span class="sd">        check whether the model or guide is written to support subsampling semantics</span>
<span class="sd">        (e.g., using NumPyro&#39;s `subsample` or similar constructs).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;`.fit()` is not supported for MCMC inference. Use `.fit_on_batch()` &quot;</span>
            <span class="s2">&quot;instead.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>

    <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="n">dataloader</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_setup_inputs</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing variational inference optimization...&quot;</span><span class="p">)</span>
    <span class="n">losses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">losses_epoch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">dataloader</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span>
                <span class="o">**</span><span class="n">batch</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span>
                <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">loss_batch</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">losses_epoch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_batch</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">loss_batch</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="n">losses_epoch_arr</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses_epoch</span><span class="p">)</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">losses_epoch_arr</span><span class="p">)</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> - &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Average loss: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_epoch_arr</span><span class="p">))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span> <span class="o">=</span> <span class="n">SVIRunResult</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">),</span>
        <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vi_state</span><span class="p">,</span>
        <span class="n">losses</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vi_result</span><span class="o">.</span><span class="n">losses</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Loss contains NaN or Inf, indicating numerical instability.&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Posterior sampling...&quot;</span><span class="p">)</span>
    <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_dict_to_datatree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.is_fitted" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">is_fitted</span>


<a href="#aimz.model.impact_model.ImpactModel.is_fitted" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">is_fitted</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="bool">bool</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Check fitted status.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>True</code> if the model is fitted, <code>False</code> otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check fitted status.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `True` if the model is fitted, `False` otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_is_fitted&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.set_posterior_sample" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">set_posterior_sample</span>


<a href="#aimz.model.impact_model.ImpactModel.set_posterior_sample" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_posterior_sample</span><span class="p">(</span><span class="n">posterior_sample</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="jax.Array">Array</span></span><span class="p">],</span> <span class="n">return_sites</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Self">Self</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set posterior samples for the model.</p>
<p>This method sets externally obtained posterior samples on the model instance,
enabling downstream analysis without requiring a call to <code>.fit()</code> or
<code>.fit_on_batch()</code>.</p>
<p>It is primarily intended for workflows where posterior sampling is performed
manually—for example, using NumPyro's <code>SVI</code> (or <code>MCMC</code>) with the <code>Predictive</code>
API—and the resulting posterior samples are injected into the model for further
use.</p>
<p>Internally, <code>batch_ndims</code> is set to <code>1</code> by default to correctly handle the batch
dimensions of the posterior samples. For more information, refer to the
<a href="https://num.pyro.ai/en/stable/utilities.html#predictive">NumPyro documentation</a>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>posterior_sample</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="jax.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Posterior samples to set for the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_sites</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of variable (sites) to
return in <code>.predict()</code>. By default, it is set to <code>self.param_output</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Self">Self</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model instance, treated as fitted with posterior samples set, enabling
method chaining.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the batch shapes in <code>posterior_sample</code> are inconsistent.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_posterior_sample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">posterior_sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Array</span><span class="p">],</span>
    <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set posterior samples for the model.</span>

<span class="sd">    This method sets externally obtained posterior samples on the model instance,</span>
<span class="sd">    enabling downstream analysis without requiring a call to `.fit()` or</span>
<span class="sd">    `.fit_on_batch()`.</span>

<span class="sd">    It is primarily intended for workflows where posterior sampling is performed</span>
<span class="sd">    manually—for example, using NumPyro&#39;s `SVI` (or `MCMC`) with the `Predictive`</span>
<span class="sd">    API—and the resulting posterior samples are injected into the model for further</span>
<span class="sd">    use.</span>

<span class="sd">    Internally, `batch_ndims` is set to `1` by default to correctly handle the batch</span>
<span class="sd">    dimensions of the posterior samples. For more information, refer to the</span>
<span class="sd">    [NumPyro documentation](https://num.pyro.ai/en/stable/utilities.html#predictive).</span>

<span class="sd">    Args:</span>
<span class="sd">        posterior_sample (dict[str, Array]): Posterior samples to set for the model.</span>
<span class="sd">        return_sites (tuple[str] | None, optional): Names of variable (sites) to</span>
<span class="sd">            return in `.predict()`. By default, it is set to `self.param_output`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The model instance, treated as fitted with posterior samples set, enabling</span>
<span class="sd">            method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the batch shapes in `posterior_sample` are inconsistent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_ndims</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">batch_shapes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">batch_ndims</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">posterior_sample</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Inconsistent batch shapes found in posterior_sample: </span><span class="si">{</span><span class="n">batch_shapes</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,)</span> <span class="o">=</span> <span class="n">batch_shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">posterior_sample</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span> <span class="o">=</span> <span class="n">return_sites</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">,)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span> <span class="o">=</span> <span class="n">_dict_to_datatree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.predict_on_batch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">predict_on_batch</span>


<a href="#aimz.model.impact_model.ImpactModel.predict_on_batch" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">predict_on_batch</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">intervention</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">in_sample</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_sites</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="xarray.DataTree">DataTree</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Predict the output based on the fitted model.</p>
<p>This method returns predictions for a single batch of input data and is better
suited for:
    1) Models incompatible with <code>.predict()</code> due to their posterior sample
        shapes.
    2) Scenarios where writing results to to files (e.g., disk, cloud storage)
        is not desired.
    3) Smaller datasets, as this method may be slower due to limited
        parallelism.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data with shape <code>(n_samples_X, n_features)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intervention</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping sample sites to
their corresponding intervention values. Interventions enable
counterfactual analysis by modifying the specified sample sites during
prediction (posterior predictive sampling).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_sample</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specifies the group where posterior predictive
samples are stored in the returned output. If <code>True</code>, samples are stored
in the <code>posterior_predictive</code> group, indicating they were generated
based on data used during model fitting. If <code>False</code>, samples are stored
in the <code>predictions</code> group, indicating they were generated based on
out-of-sample data.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_sites</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of variables (sites) to
return. If <code>None</code>, samples <code>self.param_output</code> and deterministic sites.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataTree">DataTree</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Posterior predictive samples. Posterior samples are included if available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>self.param_output</code> is passed as an argument.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_on_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict the output based on the fitted model.</span>

<span class="sd">    This method returns predictions for a single batch of input data and is better</span>
<span class="sd">    suited for:</span>
<span class="sd">        1) Models incompatible with `.predict()` due to their posterior sample</span>
<span class="sd">            shapes.</span>
<span class="sd">        2) Scenarios where writing results to to files (e.g., disk, cloud storage)</span>
<span class="sd">            is not desired.</span>
<span class="sd">        3) Smaller datasets, as this method may be slower due to limited</span>
<span class="sd">            parallelism.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike): Input data with shape `(n_samples_X, n_features)`.</span>
<span class="sd">        intervention (dict | None, optional): A dictionary mapping sample sites to</span>
<span class="sd">            their corresponding intervention values. Interventions enable</span>
<span class="sd">            counterfactual analysis by modifying the specified sample sites during</span>
<span class="sd">            prediction (posterior predictive sampling).</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed.</span>
<span class="sd">        in_sample (bool, optional): Specifies the group where posterior predictive</span>
<span class="sd">            samples are stored in the returned output. If `True`, samples are stored</span>
<span class="sd">            in the `posterior_predictive` group, indicating they were generated</span>
<span class="sd">            based on data used during model fitting. If `False`, samples are stored</span>
<span class="sd">            in the `predictions` group, indicating they were generated based on</span>
<span class="sd">            out-of-sample data.</span>
<span class="sd">        return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">            return. If `None`, samples `self.param_output` and deterministic sites.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Posterior predictive samples. Posterior samples are included if available.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

    <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
    <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.predict_on_batch()`.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intervention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">seed</span><span class="p">(</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">intervention</span><span class="p">),</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior_predictive&quot;</span> <span class="k">if</span> <span class="n">in_sample</span> <span class="k">else</span> <span class="s2">&quot;predictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dict_to_datatree</span><span class="p">(</span>
        <span class="n">_sample_forward</span><span class="p">(</span>
            <span class="n">kernel</span><span class="p">,</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
            <span class="n">posterior_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">args_bound</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.predict" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">predict</span>


<a href="#aimz.model.impact_model.ImpactModel.predict" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="aimz.utils.data.ArrayLoader" href="../array_loader/#aimz.utils.data.array_loader.ArrayLoader">ArrayLoader</a></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">intervention</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n"><span title="jax.Array">Array</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">in_sample</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_sites</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="n"><span title="pathlib.Path">Path</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="xarray.DataTree">DataTree</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Predict the output based on the fitted model.</p>
<p>This method performs posterior predictive sampling to generate model-based
predictions. It is optimized for batch processing of large input data and is not
recommended for use in loops that process only a few inputs at a time. Results
are written to disk in the Zarr format, with sampling and file writing decoupled
and executed concurrently.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span> | <a class="autorefs autorefs-internal" title="aimz.utils.data.ArrayLoader" href="../array_loader/#aimz.utils.data.array_loader.ArrayLoader">ArrayLoader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data, either an array-like of shape
<code>(n_samples, n_features)</code> or a data loader that holds all array-like
objects and handles batching internally; if a data loader is passed,
<code>batch_size</code> is ignored.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intervention</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping sample sites to
their corresponding intervention values. Interventions enable
counterfactual analysis by modifying the specified sample sites during
prediction (posterior predictive sampling).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng_key</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pseudo-random number generator key. By
default, an internal key is used and split as needed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>in_sample</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specifies the group where posterior predictive
samples are stored in the returned output. If <code>True</code>, samples are stored
in the <code>posterior_predictive</code> group, indicating they were generated
based on data used during model fitting. If <code>False</code>, samples are stored
in the <code>predictions</code> group, indicating they were generated based on
out-of-sample data.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_sites</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names of variables (sites) to
return. If <code>None</code>, samples <code>self.param_output</code> and deterministic sites.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of batches for data loading
during posterior predictive sampling. By default, it is set to the
total number of samples (<code>n_samples_X</code>). This value also determines the
chunk size for storing the posterior predictive samples.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory where the outputs
will be saved. If the specified directory does not exist, it will be
created automatically. If <code>None</code>, a default temporary directory will be
created. A timestamped subdirectory will be generated within this
directory to store the outputs. Outputs are saved in the Zarr format.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a progress bar.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataTree">DataTree</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Posterior predictive samples. Posterior samples are included if available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>self.param_output</code> is passed as an argument.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">in_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_sites</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict the output based on the fitted model.</span>

<span class="sd">    This method performs posterior predictive sampling to generate model-based</span>
<span class="sd">    predictions. It is optimized for batch processing of large input data and is not</span>
<span class="sd">    recommended for use in loops that process only a few inputs at a time. Results</span>
<span class="sd">    are written to disk in the Zarr format, with sampling and file writing decoupled</span>
<span class="sd">    and executed concurrently.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike | ArrayLoader): Input data, either an array-like of shape</span>
<span class="sd">            `(n_samples, n_features)` or a data loader that holds all array-like</span>
<span class="sd">            objects and handles batching internally; if a data loader is passed,</span>
<span class="sd">            `batch_size` is ignored.</span>
<span class="sd">        intervention (dict | None, optional): A dictionary mapping sample sites to</span>
<span class="sd">            their corresponding intervention values. Interventions enable</span>
<span class="sd">            counterfactual analysis by modifying the specified sample sites during</span>
<span class="sd">            prediction (posterior predictive sampling).</span>
<span class="sd">        rng_key (Array | None, optional): A pseudo-random number generator key. By</span>
<span class="sd">            default, an internal key is used and split as needed.</span>
<span class="sd">        in_sample (bool, optional): Specifies the group where posterior predictive</span>
<span class="sd">            samples are stored in the returned output. If `True`, samples are stored</span>
<span class="sd">            in the `posterior_predictive` group, indicating they were generated</span>
<span class="sd">            based on data used during model fitting. If `False`, samples are stored</span>
<span class="sd">            in the `predictions` group, indicating they were generated based on</span>
<span class="sd">            out-of-sample data.</span>
<span class="sd">        return_sites (tuple[str] | None, optional): Names of variables (sites) to</span>
<span class="sd">            return. If `None`, samples `self.param_output` and deterministic sites.</span>
<span class="sd">        batch_size (int | None, optional): The size of batches for data loading</span>
<span class="sd">            during posterior predictive sampling. By default, it is set to the</span>
<span class="sd">            total number of samples (`n_samples_X`). This value also determines the</span>
<span class="sd">            chunk size for storing the posterior predictive samples.</span>
<span class="sd">        output_dir (str | Path | None, optional): The directory where the outputs</span>
<span class="sd">            will be saved. If the specified directory does not exist, it will be</span>
<span class="sd">            created automatically. If `None`, a default temporary directory will be</span>
<span class="sd">            created. A timestamped subdirectory will be generated within this</span>
<span class="sd">            directory to store the outputs. Outputs are saved in the Zarr format.</span>
<span class="sd">        progress (bool, optional): Whether to display a progress bar.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Posterior predictive samples. Posterior samples are included if available.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `self.param_output` is passed as an argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Check for compatibility with the `.predict()` method.</span>
    <span class="c1">#</span>
    <span class="c1"># If any array in the posterior has shape (num_samples, num_obs)—i.e.,</span>
    <span class="c1"># `ndim == 2` and the second dimension matches the number of observations in</span>
    <span class="c1"># `X`—it suggests that the model produces per-observation posterior samples.</span>
    <span class="c1"># This makes it incompatible with the current `.predict()` implementation, which</span>
    <span class="c1"># uses sharded parallelism. In such cases, fall back to `.predict_on_batch()`</span>
    <span class="c1"># and raise a warning.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">):</span>
        <span class="n">ndim_posterior_sample</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">ndim_posterior_sample</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;One or more posterior sample shapes are not compatible with &quot;</span>
                <span class="s2">&quot;`.predict()` under sharded parallelism; falling back to &quot;</span>
                <span class="s2">&quot;`.predict_on_batch()`.&quot;</span>
            <span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span>
                <span class="n">intervention</span><span class="o">=</span><span class="n">intervention</span><span class="p">,</span>
                <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
                <span class="n">in_sample</span><span class="o">=</span><span class="n">in_sample</span><span class="p">,</span>
                <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Validate the provided parameters against the kernel&#39;s signature</span>
        <span class="n">args_bound</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span><span class="o">.</span><span class="n">arguments</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span> <span class="ow">in</span> <span class="n">args_bound</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">!r}</span><span class="s2"> is not allowed in `.predict()`.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rng_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intervention</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rng_key</span><span class="p">,</span> <span class="n">rng_subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">seed</span><span class="p">(</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">intervention</span><span class="p">),</span> <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_subkey</span><span class="p">)</span>

    <span class="n">kwargs_array</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span> <span class="o">=</span> <span class="n">_create_sharded_sampler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_array</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_extra</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Temporary directory created at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No output directory provided. Using the model&#39;s temporary directory &quot;</span>
            <span class="s2">&quot;for storing output.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">output_subdir</span> <span class="o">=</span> <span class="n">_create_output_subdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sample_posterior_predictive</span><span class="p">(</span>
        <span class="n">fn_sample_posterior_predictive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fn_sample_posterior_predictive</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span> <span class="k">if</span> <span class="n">in_sample</span> <span class="k">else</span> <span class="s2">&quot;predictions&quot;</span><span class="p">,</span>
        <span class="n">return_sites</span><span class="o">=</span><span class="n">return_sites</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_sites</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_subdir</span><span class="p">,</span>
        <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.estimate_effect" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">estimate_effect</span>


<a href="#aimz.model.impact_model.ImpactModel.estimate_effect" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">estimate_effect</span><span class="p">(</span><span class="n">output_baseline</span><span class="p">:</span> <span class="n"><span title="xarray.DataTree">DataTree</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_intervention</span><span class="p">:</span> <span class="n"><span title="xarray.DataTree">DataTree</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args_baseline</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args_intervention</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="xarray.DataTree">DataTree</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Estimate the effect of an intervention.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_baseline</code>
            </td>
            <td>
                  <code><span title="xarray.DataTree">DataTree</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Precomputed output for the
baseline scenario.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_intervention</code>
            </td>
            <td>
                  <code><span title="xarray.DataTree">DataTree</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Precomputed output for
the intervention scenario.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args_baseline</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input arguments for the baseline
scenario. Passed to the <code>.predict()</code> method to compute predictions if
<code>output_baseline</code> is not provided. Ignored if <code>output_baseline</code> is
already given.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args_intervention</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input arguments for the
intervention scenario. Passed to the <code>.predict()</code> method to compute
predictions if <code>output_intervention</code> is not provided. Ignored if
<code>output_intervention</code> is already given.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataTree">DataTree</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The estimated impact of an intervention.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If neither <code>output_baseline</code> nor <code>args_baseline</code> is provided, or
if neither <code>output_intervention</code> nor <code>args_intervention</code> is provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">estimate_effect</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_baseline</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_intervention</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">args_baseline</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">args_intervention</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the effect of an intervention.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_baseline (xr.DataTree | None, optional): Precomputed output for the</span>
<span class="sd">            baseline scenario.</span>
<span class="sd">        output_intervention (xr.DataTree | None, optional): Precomputed output for</span>
<span class="sd">            the intervention scenario.</span>
<span class="sd">        args_baseline (dict | None, optional): Input arguments for the baseline</span>
<span class="sd">            scenario. Passed to the `.predict()` method to compute predictions if</span>
<span class="sd">            `output_baseline` is not provided. Ignored if `output_baseline` is</span>
<span class="sd">            already given.</span>
<span class="sd">        args_intervention (dict | None, optional): Input arguments for the</span>
<span class="sd">            intervention scenario. Passed to the `.predict()` method to compute</span>
<span class="sd">            predictions if `output_intervention` is not provided. Ignored if</span>
<span class="sd">            `output_intervention` is already given.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The estimated impact of an intervention.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If neither `output_baseline` nor `args_baseline` is provided, or</span>
<span class="sd">            if neither `output_intervention` nor `args_intervention` is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_baseline</span><span class="p">:</span>
        <span class="n">dt_baseline</span> <span class="o">=</span> <span class="n">output_baseline</span>
    <span class="k">elif</span> <span class="n">args_baseline</span><span class="p">:</span>
        <span class="n">dt_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="o">**</span><span class="n">args_baseline</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Either `output_baseline` or `args_baseline` must be provided.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_intervention</span><span class="p">:</span>
        <span class="n">dt_intervention</span> <span class="o">=</span> <span class="n">output_intervention</span>
    <span class="k">elif</span> <span class="n">args_intervention</span><span class="p">:</span>
        <span class="n">dt_intervention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="o">**</span><span class="n">args_intervention</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Either `output_intervention` or `args_intervention` must be provided.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">_validate_group</span><span class="p">(</span><span class="n">dt_baseline</span><span class="p">,</span> <span class="n">dt_intervention</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_intervention</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt_baseline</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.log_likelihood" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">log_likelihood</span>


<a href="#aimz.model.impact_model.ImpactModel.log_likelihood" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">log_likelihood</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="aimz.utils.data.ArrayLoader" href="../array_loader/#aimz.utils.data.array_loader.ArrayLoader">ArrayLoader</a></span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n"><span title="jax.typing.ArrayLike">ArrayLike</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="n"><span title="pathlib.Path">Path</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n"><span title="object">object</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="xarray.DataTree">DataTree</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compute the log likelihood of the data under the given model.</p>
<p>Results are written to disk in the Zarr format, with computing and file writing
decoupled and executed concurrently.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span> | <a class="autorefs autorefs-internal" title="aimz.utils.data.ArrayLoader" href="../array_loader/#aimz.utils.data.array_loader.ArrayLoader">ArrayLoader</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data, either an array-like of shape
<code>(n_samples, n_features)</code> or a data loader that holds all array-like
objects and handles batching internally; if a data loader is passed,
<code>batch_size</code> is ignored.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output data with shape <code>(n_samples_Y,)</code>. Must be
<code>None</code> if <code>X</code> is a data loader.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of batches for data loading
during posterior predictive sampling. By default, it is set to the total
number of samples (<code>n_samples_X</code>). This value also determines the chunk
size for storing the log-likelihood values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory where the outputs
will be saved. If the specified directory does not exist, it will be
created automatically. If <code>None</code>, a default temporary directory will be
created. A timestamped subdirectory will be generated within this
directory to store the outputs. Outputs are saved in the Zarr format.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a progress bar.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the model. All array-like
values are expected to be JAX arrays.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="xarray.DataTree">DataTree</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log-likelihood values. Posterior samples are included if available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_likelihood</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="n">ArrayLoader</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the log likelihood of the data under the given model.</span>

<span class="sd">    Results are written to disk in the Zarr format, with computing and file writing</span>
<span class="sd">    decoupled and executed concurrently.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (ArrayLike | ArrayLoader): Input data, either an array-like of shape</span>
<span class="sd">            `(n_samples, n_features)` or a data loader that holds all array-like</span>
<span class="sd">            objects and handles batching internally; if a data loader is passed,</span>
<span class="sd">            `batch_size` is ignored.</span>
<span class="sd">        y (ArrayLike | None): Output data with shape `(n_samples_Y,)`. Must be</span>
<span class="sd">            `None` if `X` is a data loader.</span>
<span class="sd">        batch_size (int | None, optional): The size of batches for data loading</span>
<span class="sd">            during posterior predictive sampling. By default, it is set to the total</span>
<span class="sd">            number of samples (`n_samples_X`). This value also determines the chunk</span>
<span class="sd">            size for storing the log-likelihood values.</span>
<span class="sd">        output_dir (str | Path | None, optional): The directory where the outputs</span>
<span class="sd">            will be saved. If the specified directory does not exist, it will be</span>
<span class="sd">            created automatically. If `None`, a default temporary directory will be</span>
<span class="sd">            created. A timestamped subdirectory will be generated within this</span>
<span class="sd">            directory to store the outputs. Outputs are saved in the Zarr format.</span>
<span class="sd">        progress (bool, optional): Whether to display a progress bar.</span>
<span class="sd">        **kwargs (object): Additional arguments passed to the model. All array-like</span>
<span class="sd">            values are expected to be JAX arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Log-likelihood values. Posterior samples are included if available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">kwargs_array</span><span class="p">,</span> <span class="n">kwargs_extra</span> <span class="o">=</span> <span class="n">_group_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span> <span class="o">=</span> <span class="n">_create_sharded_log_likelihood</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_array</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">kwargs_extra</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Temporary directory created at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No output directory provided. Using the model&#39;s temporary directory &quot;</span>
            <span class="s2">&quot;for storing output.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">output_subdir</span> <span class="o">=</span> <span class="n">_create_output_subdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="n">dataloader</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_setup_inputs</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">desc</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing log-likelihood of </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">),</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span>
        <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">zarr_group</span> <span class="o">=</span> <span class="n">open_group</span><span class="p">(</span><span class="n">output_subdir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">zarr_arr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">error_queue</span> <span class="o">=</span> <span class="n">_start_writer_threads</span><span class="p">(</span>
        <span class="p">(</span><span class="n">site</span><span class="p">,),</span>
        <span class="n">group_path</span><span class="o">=</span><span class="n">output_subdir</span><span class="p">,</span>
        <span class="n">writer</span><span class="o">=</span><span class="n">_writer</span><span class="p">,</span>
        <span class="n">queue_size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">n_pad</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="n">kwargs_batch</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">device_get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fn_log_likelihood</span><span class="p">(</span>
                    <span class="c1"># Although computing the log-likelihood is deterministic, the</span>
                    <span class="c1"># model still needs to be seeded in order to trace its graph.</span>
                    <span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rng_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">,</span>
                    <span class="n">site</span><span class="p">,</span>
                    <span class="n">kwargs_array</span><span class="o">.</span><span class="n">_fields</span> <span class="o">+</span> <span class="n">kwargs_extra</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span>
                    <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">param_input</span><span class="p">],</span>
                    <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">param_output</span><span class="p">],</span>
                    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs_batch</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs_extra</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zarr_arr</span><span class="p">:</span>
                <span class="n">zarr_arr</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">zarr_group</span><span class="o">.</span><span class="n">create_array</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;bfloat16&quot;</span> <span class="k">else</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">chunks</span><span class="o">=</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">,</span>
                        <span class="n">dataloader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                        <span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
                    <span class="p">),</span>
                    <span class="n">dimension_names</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;draw&quot;</span><span class="p">,</span>
                        <span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">_dim_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="n">queues</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span> <span class="p">:</span> <span class="o">-</span><span class="n">n_pad</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">error_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">error_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Computation complete, writing in progress...&quot;</span><span class="p">)</span>
        <span class="n">_shutdown_writer_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="n">queues</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">_shutdown_writer_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="n">queues</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s2">&quot;Exception encountered. Cleaning up output directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">output_subdir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">output_subdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">open_zarr</span><span class="p">(</span><span class="n">output_subdir</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
        <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">_make_attrs</span><span class="p">())</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;posterior&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt_posterior</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataTree</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="aimz.model.impact_model.ImpactModel.cleanup" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">cleanup</span>


<a href="#aimz.model.impact_model.ImpactModel.cleanup" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">cleanup</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Clean up the temporary directory created for storing outputs.</p>
<p>If the temporary directory was never created or has already been cleaned up,
this method does nothing. It does not delete any explicitly specified output
directory. While the temporary directory is typically removed automatically
during garbage collection, this behavior is not guaranteed. Therefore, calling
this method explicitly is recommended to ensure timely resource release.</p>


            <details class="quote">
              <summary>Source code in <code>aimz/model/impact_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up the temporary directory created for storing outputs.</span>

<span class="sd">    If the temporary directory was never created or has already been cleaned up,</span>
<span class="sd">    this method does nothing. It does not delete any explicitly specified output</span>
<span class="sd">    directory. While the temporary directory is typically removed automatically</span>
<span class="sd">    during garbage collection, this behavior is not guaranteed. Therefore, calling</span>
<span class="sd">    this method explicitly is recommended to ensure timely resource release.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;temp_dir&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Temporary directory cleaned up at: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Eli Lilly and Company
    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/markean/aimz" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:markean@pm.me" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M536.4-26.3c9.8-3.5 20.6-1 28 6.3s9.8 18.2 6.3 28l-178 496.9c-5 13.9-18.1 23.1-32.8 23.1-14.2 0-27-8.6-32.3-21.7l-64.2-158c-4.5-11-2.5-23.6 5.2-32.6l94.5-112.4c5.1-6.1 4.7-15-.9-20.6s-14.6-6-20.6-.9l-112.4 94.3c-9.1 7.6-21.6 9.6-32.6 5.2L38.1 216.8c-13.1-5.3-21.7-18.1-21.7-32.3 0-14.7 9.2-27.8 23.1-32.8z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["announce.dismiss", "content.code.copy", "content.action.view", "header.autohide", "navigation.tracking", "navigation.sections", "navigation.indexes", "navigation.path", "navigation.instant", "navigation.instant.progress", "navigation.top", "search.suggest", "search.share"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>